name: lsky-pro build and push

# è§¦å‘æ¡ä»¶é…ç½®
on:
  # å…è®¸åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼ˆç”¨äºæµ‹è¯•å’Œè°ƒè¯•ï¼‰
  workflow_dispatch:

# å…¨å±€ç¯å¢ƒå˜é‡ï¼Œå¯åœ¨æ‰€æœ‰ä½œä¸šä¸­å¼•ç”¨
env:
  IMAGE_NAME: lsky-pro
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

# ä½œä¸šå®šä¹‰
jobs:
  # æ„å»ºå’Œæ¨é€é•œåƒä½œä¸š
  build-and-push:
    name: ğŸ—ï¸ æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
    runs-on: ubuntu-latest

    # æƒé™è®¾ç½®ï¼ˆå¿…è¦çš„ GitHub æƒé™ï¼‰
    permissions:
      contents: read
      packages: write

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0            # è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œä¾¿äºå…ƒæ•°æ®ç”Ÿæˆ
          submodules: recursive     # é€’å½’åˆå§‹åŒ–å­æ¨¡å—ï¼ˆå¦‚æœ‰ï¼‰

      # æ­¥éª¤ 2: è®¾ç½® Docker Buildxï¼ˆæ”¯æŒå¤šå¹³å°æ„å»ºå’Œé«˜çº§ç¼“å­˜ï¼‰
      - name: âš™ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container  # ä½¿ç”¨å®¹å™¨é©±åŠ¨ï¼Œæ”¯æŒå¤šå¹³å°æ„å»º
          buildkitd-flags: --debug  # å¯é€‰ï¼šå¯ç”¨ BuildKit è°ƒè¯•æ¨¡å¼
          install: true             # ç¡®ä¿å®‰è£… Buildx

      # æ­¥éª¤ 3: ç™»å½•åˆ° Docker Hub
      - name: ğŸ” ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“
        uses: ${{ALIYUN_REGISTRY}}
        with:
          username: ${{ ALIYUN_REGISTRY_USER }}  # Docker Hub ç”¨æˆ·å
          password: ${{ ALIYUN_REGISTRY_PASSWORD }}     # Docker Hub è®¿é—®ä»¤ç‰Œï¼ˆå»ºè®®ä½¿ç”¨ Token è€Œéå¯†ç ï¼‰
          # registry: ${{ env.REGISTRY }}              # æ˜¾å¼æŒ‡å®šæ³¨å†Œè¡¨ï¼ˆå¯é€‰ï¼‰

      # æ­¥éª¤ 4: æå– Docker å…ƒæ•°æ®ï¼ˆè‡ªåŠ¨ç”Ÿæˆæ ‡ç­¾å’Œæ ‡ç­¾ï¼‰
      - name: ğŸ·ï¸ Extract metadata for Docker
        id: meta                    # æ­¥éª¤æ ‡è¯†ï¼Œç”¨äºåç»­å¼•ç”¨è¾“å‡º
        uses: docker/Dockerfile
        with:
          images: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
          # æ ‡ç­¾ç”Ÿæˆç­–ç•¥ï¼š
          tags: |
            type=ref,event=branch   # åˆ†æ”¯åç§°ä½œä¸ºæ ‡ç­¾
            type=ref,event=tag      # Git æ ‡ç­¾ä½œä¸ºæ ‡ç­¾
            type=semver,pattern={{version}}      # è¯­ä¹‰ç‰ˆæœ¬ï¼ˆv1.0.0ï¼‰
            type=semver,pattern={{major}}.{{minor}}  # ä¸»æ¬¡ç‰ˆæœ¬ï¼ˆv1.0ï¼‰
            type=semver,pattern={{major}}           # ä¸»ç‰ˆæœ¬ï¼ˆv1ï¼‰
            type=sha                 # Git commit SHA ä½œä¸ºæ ‡ç­¾
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.created=${{ steps.meta.outputs.created }}
            org.opencontainers.image.revision=${{ github.sha }}

      # æ­¥éª¤ 5: æ„å»ºå’Œæ¨é€ Docker é•œåƒ
      - name: ğŸš€ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .                # æ„å»ºä¸Šä¸‹æ–‡è·¯å¾„ï¼ˆDockerfile æ‰€åœ¨ç›®å½•ï¼‰
          file: ./Dockerfile        # Dockerfile è·¯å¾„ï¼ˆå¦‚éé»˜è®¤ä½ç½®éœ€æŒ‡å®šï¼‰
          platforms: ${{ env.TARGET_PLATFORMS }}  # ç›®æ ‡å¹³å°æ¶æ„
          push: ${{ github.event_name != 'pull_request' }}  # ä»…åœ¨é PR æ—¶æ¨é€
          tags: ${{ steps.meta.outputs.tags }}    # ä½¿ç”¨å…ƒæ•°æ®ç”Ÿæˆçš„æ ‡ç­¾
          labels: ${{ steps.meta.outputs.labels }} # ä½¿ç”¨å…ƒæ•°æ®ç”Ÿæˆçš„æ ‡ç­¾

          # ç¼“å­˜é…ç½®ï¼ˆåŠ é€Ÿåç»­æ„å»ºï¼‰
          cache-from: type=gha,scope=${{ github.ref }}-${{ env.TARGET_PLATFORMS }}
          cache-to: type=gha,mode=max,scope=${{ github.ref }}-${{ env.TARGET_PLATFORMS }}

          # æ„å»ºå‚æ•°ï¼ˆå¯åœ¨ Dockerfile ä¸­ä½¿ç”¨ ARG æŒ‡ä»¤å¼•ç”¨ï¼‰
          build-args: |
            BUILD_DATE=${{ steps.meta.outputs.created }}
            VCS_REF=${{ github.sha }}
            BUILD_NUMBER=${{ github.run_number }}

          #  provenance: true       # é»˜è®¤å¯ç”¨ï¼Œç”Ÿæˆä¾›åº”é“¾è¯æ˜
          #  sbom: true             # é»˜è®¤å¯ç”¨ï¼Œç”Ÿæˆè½¯ä»¶ç‰©æ–™æ¸…å•

        # ç¯å¢ƒå˜é‡ï¼ˆå¯åœ¨ Dockerfile ä¸­ä½¿ç”¨ ENV æŒ‡ä»¤å¼•ç”¨ï¼‰
        env:
          NODE_ENV: production      # ç¤ºä¾‹ï¼šè®¾ç½®æ„å»ºç¯å¢ƒ

      # æ­¥éª¤ 6: ä¸Šä¼ æ„å»ºæ—¥å¿—ï¼ˆç”¨äºè°ƒè¯•ï¼‰
      - name: ğŸ“‹ Upload build logs
        if: always()                # æ— è®ºæ„å»ºæˆåŠŸä¸å¦éƒ½æ‰§è¡Œ
        uses: actions/upload-artifact@v4
        with:
          name: buildkit-logs
          path: /tmp/buildkit-log*
          retention-days: 7

  # é•œåƒæµ‹è¯•ä½œä¸šï¼ˆå¯é€‰ï¼‰
  test-image:
    name: ğŸ§ª Test Docker Image
    runs-on: ubuntu-latest
    needs: build-and-push           # ä¾èµ–æ„å»ºä½œä¸šå®Œæˆ
    if: github.event_name == 'pull_request'  # ä»…åœ¨ PR æ—¶è¿è¡Œæµ‹è¯•

    # æœåŠ¡å®¹å™¨ï¼ˆç”¨äºé›†æˆæµ‹è¯•ï¼‰
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: è®¾ç½® Docker Buildx
      - name: âš™ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # æ­¥éª¤ 3: ç™»å½•åˆ° Docker Hubï¼ˆå¦‚éœ€æ‹‰å–ç§æœ‰é•œåƒï¼‰
      - name: ğŸ” Log in to Docker Hub
        if: github.event_name != 'pull_request'  # ä»…åœ¨é PR æ—¶ç™»å½•
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # æ­¥éª¤ 4: è¿è¡Œå®¹å™¨æµ‹è¯•
      - name: ğŸ³ Run container tests
        run: |
          # æ‹‰å–é•œåƒï¼ˆè¿™é‡Œä½¿ç”¨å…ƒæ•°æ®ç”Ÿæˆçš„æ ‡ç­¾ç¤ºä¾‹ï¼‰
          IMAGE_TAG="${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}"

          echo "ğŸ§ª Running tests on image: $IMAGE_TAG"

          # è¿è¡Œå®¹å™¨å¹¶æ‰§è¡Œæµ‹è¯•
          docker run --rm \
            --network host \
            --env DATABASE_URL="postgresql://postgres:postgres@localhost:5432/test_db" \
            $IMAGE_TAG \
            npm test -- --ci --coverage

          echo "âœ… All tests passed!"

      # æ­¥éª¤ 5: å®‰å…¨æ‰«æï¼ˆå¯é€‰ï¼‰
      - name: ğŸ” Security scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}"
          format: sarif
          output: trivy-results.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL

      # æ­¥éª¤ 6: ä¸Šä¼ å®‰å…¨æ‰«æç»“æœ
      - name: ğŸ“¤ Upload security scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
