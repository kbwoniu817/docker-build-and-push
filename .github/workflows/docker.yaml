name: ğŸ³ Build and Push to Aliyun ACR

# è§¦å‘æ¡ä»¶é…ç½®
on:
  workflow_dispatch:                   # å…è®¸æ‰‹åŠ¨è§¦å‘

# ç¯å¢ƒå˜é‡é…ç½®
env:
  IMAGE_NAME: lsky-pro		          # é•œåƒåç§°
  ALIYUN_REGION: cn-chengdu        	# é˜¿é‡Œäº‘åŒºåŸŸï¼ˆæ ¹æ®ä½ çš„ä»“åº“ä¿®æ”¹ï¼‰
  NAMESPACE: byte-blazer	          # é˜¿é‡Œäº‘å‘½åç©ºé—´:cite[1]:cite[7]

jobs:
  build-and-push:
    name: ğŸ—ï¸ Build and Push to Aliyun ACR
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0              # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºå…ƒæ•°æ®ç”Ÿæˆ

      # æ­¥éª¤2: è®¾ç½®Docker Buildxï¼ˆæ”¯æŒé«˜çº§æ„å»ºç‰¹æ€§ï¼‰
      - name: âš™ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container    # ä½¿ç”¨å®¹å™¨é©±åŠ¨ï¼Œæ”¯æŒå¤šå¹³å°æ„å»º
          install: true               # ç¡®ä¿å®‰è£…Buildx

      # æ­¥éª¤3: æå–å…ƒæ•°æ®ï¼ˆè‡ªåŠ¨ç”Ÿæˆæ ‡ç­¾ï¼‰
      - name: ğŸ·ï¸ Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.ALIYUN_REGION }}.aliyuncs.com/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch     # åˆ†æ”¯åç§°ä½œä¸ºæ ‡ç­¾
            type=ref,event=tag        # Gitæ ‡ç­¾ä½œä¸ºæ ‡ç­¾
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha                  # Commit SHAä½œä¸ºæ ‡ç­¾
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ steps.meta.outputs.created }}

      # æ­¥éª¤4: ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
      - name: ğŸ” Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIYUN_REGION }}.aliyuncs.com
          username: ${{ secrets.ALIYUN_ACR_USERNAME }}      # é˜¿é‡Œäº‘ç”¨æˆ·å:cite[1]:cite[4]
          password: ${{ secrets.ALIYUN_ACR_PASSWORD }}      # é˜¿é‡Œäº‘å¯†ç æˆ–è®¿é—®ä»¤ç‰Œ:cite[1]:cite[4]

      # æ­¥éª¤5: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      - name: ğŸš€ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .                  # ä½¿ç”¨å½“å‰ç›®å½•ä½œä¸ºæ„å»ºä¸Šä¸‹æ–‡
          file: ./Dockerfile         # Dockerfileè·¯å¾„ï¼ˆå¦‚æœåœ¨æ ¹ç›®å½•ï¼‰
          push: ${{ github.event_name != 'pull_request' }}  # PRæ—¶ä¸æ¨é€
          tags: ${{ steps.meta.outputs.tags }}              # ä½¿ç”¨å…ƒæ•°æ®ç”Ÿæˆçš„æ ‡ç­¾
          labels: ${{ steps.meta.outputs.labels }}          # ä½¿ç”¨å…ƒæ•°æ®ç”Ÿæˆçš„æ ‡ç­¾
          cache-from: type=gha,scope=${{ github.ref }}-${{ env.IMAGE_NAME }}
          cache-to: type=gha,mode=max,scope=${{ github.ref }}-${{ env.IMAGE_NAME }}
          provenance: false           # å¦‚éœ€ç”Ÿæˆä¾›åº”é“¾è¯æ˜å¯è®¾ä¸ºtrue

      # æ­¥éª¤6: ä¸Šä¼ æ„å»ºæ—¥å¿—ï¼ˆç”¨äºè°ƒè¯•ï¼‰
      - name: ğŸ“‹ Upload build logs
        if: always()                  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        with:
          name: buildkit-logs
          path: /tmp/buildkit-log*
          retention-days: 7

  # å¯é€‰ï¼šå®‰å…¨æ‰«ææ­¥éª¤
  security-scan:
    name: ğŸ” Security Scan
    runs-on: ubuntu-latest
    needs: build-and-push
    if: success() && github.event_name != 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.ALIYUN_REGION }}.aliyuncs.com/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: sarif
          output: trivy-results.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          
      - name: Upload security scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
